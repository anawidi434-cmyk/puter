<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Generator (Bypass Funding Error)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>

  <style>
    /* Tombol Reset yang selalu berada di atas semua elemen */
    #reset-btn-fixed {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 999999; /* Sangat tinggi agar tidak tertutup pesan error */
    }
    .result-container img, .result-container video {
      max-height: 500px;
      object-fit: contain;
    }
  </style>
</head>

<body class="bg-black text-gray-100 min-h-screen">

  <div id="reset-btn-fixed">
    <button onclick="forceReset()" 
      class="bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-full font-black shadow-[0_0_20px_rgba(220,38,38,0.5)] border-2 border-white flex items-center gap-2 transition-all hover:scale-105 active:scale-95">
      üîÑ RESET KUOTA / GANTI AKUN
    </button>
  </div>

  <div class="max-w-4xl mx-auto p-6 pt-20">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
        AI Video & Image Gen
      </h1>
      <p class="text-gray-500 mt-2">Jika muncul error "Not enough funding", tekan tombol merah di atas.</p>
    </header>

    <div class="bg-gray-900/50 p-6 rounded-3xl border border-gray-800 backdrop-blur-sm shadow-2xl mb-10">
      <textarea id="prompt"
        class="w-full p-4 rounded-2xl bg-gray-950 border border-gray-700 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none text-white transition-all text-lg"
        rows="3"
        placeholder="Deskripsikan gambar atau video..."></textarea>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div>
          <label class="text-[10px] text-gray-500 font-bold tracking-widest uppercase mb-2 block">Ukuran</label>
          <select id="ratio" class="w-full bg-gray-950 border border-gray-700 p-3 rounded-xl outline-none focus:border-emerald-500">
            <option value="1:1">1:1 (Square)</option>
            <option value="16:9" selected>16:9 (Landscape)</option>
            <option value="9:16">9:16 (Portrait)</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] text-gray-500 font-bold tracking-widest uppercase mb-2 block">Durasi (Video)</label>
          <select id="duration" class="w-full bg-gray-950 border border-gray-700 p-3 rounded-xl outline-none focus:border-emerald-500">
            <option value="4">4 Detik</option>
            <option value="8" selected>8 Detik</option>
            <option value="12">12 Detik</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button onclick="generate('image')" class="bg-white text-black hover:bg-gray-200 px-4 py-3 rounded-xl flex-1 font-bold transition-all shadow-lg">üñº Gambar</button>
          <button onclick="generate('video')" class="bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-xl flex-1 font-bold transition-all shadow-lg">üé• Video</button>
        </div>
      </div>
    </div>

    <div id="loading" class="hidden flex flex-col items-center my-10 animate-pulse">
      <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
      <p class="text-yellow-500 font-bold">AI sedang memproses... (Sekitar 30-60 detik)</p>
    </div>

    <div id="result" class="result-container flex justify-center mb-16"></div>

    <div class="border-t border-gray-800 pt-10">
      <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
        <span>üìÅ Riwayat Sesi Ini</span>
        <span class="text-xs font-normal text-gray-500">(Tersimpan di browser)</span>
      </h2>
      <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </div>
  </div>

<script>
// Referensi UI
const loading = document.getElementById("loading");
const result = document.getElementById("result");
const gallery = document.getElementById("gallery");

// FUNGSI UTAMA: Reset Sesi (Bypass Kuota)
async function forceReset() {
    if(confirm("Sesi akan di-reset. Tindakan ini akan mengeluarkan Anda dari akun saat ini untuk mencoba mendapatkan kuota baru. Lanjutkan?")) {
        try {
            await puter.auth.signOut();
            // Membersihkan data lokal yang mungkin menempel
            localStorage.clear();
            sessionStorage.clear();
            // Reload paksa
            window.location.href = window.location.pathname + "?reload=" + Date.now();
        } catch (e) {
            window.location.reload();
        }
    }
}

function showLoading(show) {
    loading.classList.toggle("hidden", !show);
    if(show) result.innerHTML = "";
}

function getDimensions() {
    const r = document.getElementById("ratio").value;
    if (r === "1:1") return "1024x1024";
    if (r === "9:16") return "720x1280";
    return "1280x720";
}

// Fungsi Generate (Gabungan)
async function generate(type) {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) return alert("Masukkan deskripsi terlebih dahulu!");

    showLoading(true);
    
    try {
        let output;
        if (type === 'image') {
            output = await puter.ai.txt2img(prompt, { size: getDimensions() });
        } else {
            output = await puter.ai.txt2vid(prompt, {
                model: "sora-2",
                seconds: parseInt(document.getElementById("duration").value),
                size: getDimensions()
            });
        }

        showLoading(false);
        output.className = "rounded-2xl border-2 border-gray-800 shadow-2xl max-w-full";
        if(type === 'video') output.controls = true;
        
        result.appendChild(output);
        
        // Simpan ke riwayat
        const src = type === 'video' ? (output.querySelector("source")?.src || output.src) : output.src;
        saveToHistory(type, src);

    } catch (err) {
        showLoading(false);
        console.error("Puter Error:", err);

        // Deteksi Otomatis Funding/Quota Error
        if (err.message && (err.message.toLowerCase().includes("funding") || err.message.toLowerCase().includes("upgrade") || err.message.toLowerCase().includes("quota"))) {
            alert("‚ö†Ô∏è KUOTA HABIS!\n\nPuter mendeteksi akun Anda kekurangan dana (funding). Silakan tekan tombol merah 'RESET KUOTA' di pojok kanan atas untuk menyegarkan sesi.");
        } else {
            alert("Terjadi kesalahan: " + err.message);
        }
    }
}

function saveToHistory(type, src) {
    const history = JSON.parse(localStorage.getItem("ai_gen_history") || "[]");
    history.unshift({ type, src, time: new Date().toLocaleTimeString() });
    localStorage.setItem("ai_gen_history", JSON.stringify(history.slice(0, 12)));
    renderHistory();
}

function renderHistory() {
    gallery.innerHTML = "";
    const history = JSON.parse(localStorage.getItem("ai_gen_history") || "[]");
    
    history.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-gray-900/50 p-2 rounded-2xl border border-gray-800 overflow-hidden";
        
        const media = item.type === "image" ? document.createElement("img") : document.createElement("video");
        media.src = item.src;
        if(item.type === "video") media.controls = true;
        media.className = "rounded-xl w-full aspect-video object-cover bg-black mb-2";
        
        const info = document.createElement("div");
        info.className = "flex justify-between items-center px-2 pb-1";
        info.innerHTML = `<span class="text-[10px] text-gray-600 font-mono">${item.time}</span>
                         <a href="${item.src}" download class="text-[10px] bg-gray-800 px-2 py-1 rounded text-gray-300">Download</a>`;
        
        card.append(media, info);
        gallery.appendChild(card);
    });
}

// Jalankan history saat pertama buka
renderHistory();
</script>
</body>
</html>
