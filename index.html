<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Generator - Fixed Reset</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    /* Menjamin tombol reset selalu di depan */
    #emergency-reset {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
    }
  </style>
</head>

<body class="bg-gray-950 text-white min-h-screen pb-20">

  <div id="emergency-reset">
    <button onclick="resetAccount()" 
      class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full font-bold shadow-2xl border-2 border-white flex items-center gap-2 transition-transform active:scale-95">
      ğŸ”„ RESET SESI SEKARANG
    </button>
  </div>

  <div class="max-w-5xl mx-auto p-6 pt-16">

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-blue-400">ğŸ¬ AI Video & Image</h1>
      <p class="text-gray-400">Jika muncul "Not enough funding", klik tombol merah di pojok kanan atas.</p>
    </div>

    <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-xl mb-10">
      <textarea id="prompt"
        class="w-full p-4 rounded-xl bg-gray-950 border border-gray-700 focus:border-blue-500 outline-none text-white mb-4"
        rows="3"
        placeholder="Contoh: A cyberpunk city in 2077, rain, neon lights..."></textarea>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-xs text-gray-500 font-bold mb-1 block">ASPECT RATIO</label>
          <select id="ratio" class="w-full bg-gray-950 border border-gray-700 p-2.5 rounded-lg">
            <option value="1:1">1:1 (Square)</option>
            <option value="16:9" selected>16:9 (Landscape)</option>
            <option value="9:16">9:16 (Portrait)</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500 font-bold mb-1 block">DURASI</label>
          <select id="duration" class="w-full bg-gray-950 border border-gray-700 p-2.5 rounded-lg">
            <option value="4">4 detik</option>
            <option value="8" selected>8 detik</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button onclick="generateImage()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2.5 rounded-lg flex-1 font-bold">ğŸ–¼ Image</button>
          <button onclick="generateVideo()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2.5 rounded-lg flex-1 font-bold">ğŸ¥ Video</button>
        </div>
      </div>
    </div>

    <div id="loading" class="hidden text-center my-10 animate-bounce">
      <span class="bg-yellow-500 text-black px-4 py-1 rounded-full font-bold">â³ AI sedang bekerja...</span>
    </div>

    <div id="result" class="flex justify-center mb-10"></div>

    <h2 class="text-xl font-bold mb-4 border-b border-gray-800 pb-2">ğŸ“ History</h2>
    <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

  </div>

<script>
const loading = document.getElementById("loading");
const result = document.getElementById("result");
const gallery = document.getElementById("gallery");

// Fungsi Reset Mutlak
async function resetAccount() {
    try {
        // Hapus session dari Puter
        await puter.auth.signOut();
        // Hapus cache browser yang mungkin menyimpan ID lama
        localStorage.clear();
        alert("Sesi dihapus. Halaman akan memuat ulang untuk mendapatkan identitas baru.");
        window.location.reload();
    } catch (e) {
        // Jika puter.auth gagal, paksa bersihkan dan reload
        window.location.reload();
    }
}

function showLoading(v) {
    loading.classList.toggle("hidden", !v);
    if(v) result.innerHTML = "";
}

function getSize() {
    const r = document.getElementById("ratio").value;
    if (r === "1:1") return "1024x1024";
    if (r === "9:16") return "720x1280";
    return "1280x720";
}

async function generateImage() {
    const prompt = document.getElementById("prompt").value;
    showLoading(true);
    try {
        const img = await puter.ai.txt2img(prompt, { size: getSize() });
        showLoading(false);
        img.className = "rounded-xl border border-gray-700 max-w-full shadow-2xl";
        result.appendChild(img);
        saveHistory("image", img.src);
    } catch (err) {
        showLoading(false);
        handleError(err);
    }
}

async function generateVideo() {
    const prompt = document.getElementById("prompt").value;
    showLoading(true);
    try {
        const video = await puter.ai.txt2vid(prompt, {
            model: "sora-2",
            seconds: parseInt(document.getElementById("duration").value),
            size: getSize()
        });
        showLoading(false);
        video.controls = true;
        video.className = "rounded-xl border border-gray-700 w-full shadow-2xl";
        result.appendChild(video);
        const src = video.querySelector("source")?.src || video.src;
        saveHistory("video", src);
    } catch (err) {
        showLoading(false);
        handleError(err);
    }
}

function handleError(err) {
    console.error(err);
    // Jika terdeteksi error funding/quota
    if (err.message && (err.message.includes("funding") || err.message.includes("upgrade") || err.message.includes("quota"))) {
        alert("âš ï¸ KUOTA ANDA HABIS.\n\nKlik tombol merah 'RESET SESI SEKARANG' di pojok kanan atas untuk mendapatkan kuota gratis baru.");
    } else {
        alert("Error: " + err.message);
    }
}

function saveHistory(type, src) {
    const items = JSON.parse(localStorage.getItem("ai_history") || "[]");
    items.unshift({ type, src });
    localStorage.setItem("ai_history", JSON.stringify(items.slice(0, 12)));
    renderHistory();
}

function renderHistory() {
    gallery.innerHTML = "";
    const items = JSON.parse(localStorage.getItem("ai_history") || "[]");
    items.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-gray-900 p-2 rounded-lg border border-gray-800";
        const el = item.type === "image" ? document.createElement("img") : document.createElement("video");
        el.src = item.src;
        if(item.type === "video") el.controls = true;
        el.className = "rounded w-full aspect-video object-cover";
        div.appendChild(el);
        gallery.appendChild(div);
    });
}

renderHistory();
</script>
</body>
</html>
